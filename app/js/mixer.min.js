var ascensionLevels,username=getUrlParameter("username");function mixerSocketConnect(endpoints){if("WebSocket"in window){var randomEndpoint=endpoints[Math.floor(Math.random()*endpoints.length)],ws=new ReconnectingWebSocket(randomEndpoint);console.log("Connected to "+randomEndpoint),ws.onopen=function(){var connector=JSON.stringify({type:"method",method:"auth",arguments:[userID],id:1});ws.send(connector),console.log("Connection opened..."),"0"===timeToShowChat?$("<div class='chat__message chat__message--mixer' id='1'>Mixer chat connection established to "+username+".</div>").appendTo(".chat"):$("<div class='chat__message chat__message--mixer' id='1'>Mixer chat connection established to "+username+".</div>").appendTo(".chat").hide().fadeIn("fast").delay(timeToShowChat).fadeOut("fast",function(){$(this).remove()}),setInterval(function(){errorHandle(ws)},1e4)},ws.onmessage=function(evt){chat(evt),console.log(evt)},ws.onclose=function(){console.log("Connection is closed...")}}else console.error("Woah, something broke. Abandon ship!")}function chat(evt){var evtString=$.parseJSON(evt.data),eventType=evtString.event,eventMessage=evtString.data;if("ChatMessage"==eventType){var username=eventMessage.user_name,userlevel=eventMessage.user_ascension_level,userlevelColor=ascensionLevels[eventMessage.user_ascension_level].color,userlevelImage=ascensionLevels[eventMessage.user_ascension_level].assetsUrl.replace("{variant}","cutout.png"),userroles=eventMessage.user_roles.toString().replace(/,/g," "),usermessage=eventMessage.message.message,messageID=eventMessage.id,completeMessage="",action="";if(eventMessage.message.meta.me&&(action="chat__message--action"),eventMessage.message.meta.is_skill&&(action="chat__message--sticker"),$.each(usermessage,function(){var type=this.type;if("text"==type){var messageText=this.data.replace(/([<>&])/g,function(chr){return"<"===chr?"&lt;":">"===chr?"&gt;":"&amp;"});completeMessage+=messageText}else if("emoticon"==type){var emoticonSource=this.source,emoticonPack=this.pack,emoticonCoordX=this.coords.x,emoticonCoordY=this.coords.y;"builtin"==emoticonSource?completeMessage+='<div class="emoticon emoticon--mixer" style="background-image: url(https://Mixer.com/_latest/emoticons/'+emoticonPack+".png); background-position: -"+emoticonCoordX+"px -"+emoticonCoordY+'px; height: 24px; width: 24px; display: inline-block;"></div>':"external"==emoticonSource&&(completeMessage+='<div class="emoticon emoticon--mixer" style="background-image: url('+emoticonPack+"); background-position: -"+emoticonCoordX+"px -"+emoticonCoordY+'px; height: 24px; width: 24px; display: inline-block;"></div>')}else if("link"==type){var chatLink=this.text.replace(/(<([^>]+)>)/gi,"");completeMessage+=chatLink}else if("tag"==type){var userTag=this.text;completeMessage+=userTag}else if("image"==type){var stickerCurrency,stickerName=this.text,stickerSource=this.url,stickerCost=eventMessage.message.meta.skill.cost;stickerCurrency="Sparks"==eventMessage.message.meta.skill.currency?'<img class="currency currency--sparks" src="assets/sparks.png" alt="Sparks">':'<img class="currency currency--embers" src="https://mixer.com/_static/img/design/ui/embers/ember_20.png" alt="Embers">',completeMessage+="used sticker: <strong>"+stickerName+"</strong> ("+stickerCurrency+" "+stickerCost+')<br><img src="'+stickerSource+'" alt="'+stickerName+'">'}}),completeMessage.endsWith("[T]"))return;"0"===timeToShowChat?$("<div class='chat__message chat__message--mixer "+eventMessage.user_id+" "+action+"' id='"+messageID+"'><div class='chat__message__username chat__message__username--"+userroles+"'>"+username+" <div class='badges'><img class='badges__badge--mixer' src="+subIcon+'></div><div class="badges__ascensionlevel" style="background-color: '+userlevelColor+';"><img src="'+userlevelImage+'" alt="">'+userlevel+"</div></div> "+completeMessage+"</div>").appendTo(".chat"):$("<div class='chat__message chat__message--mixer "+eventMessage.user_id+" "+action+"' id='"+messageID+"'><div class='chat__message__username chat__message__username--"+userroles+"'>"+username+" <div class='badges'><img class='badges__badge--mixer' src="+subIcon+'></div><div class="badges__ascensionlevel" style="background-color: '+userlevelColor+';"><img src="'+userlevelImage+'" alt="">'+userlevel+"</div></div> "+completeMessage+"</div>").appendTo(".chat").hide().fadeIn("fast").delay(timeToShowChat).fadeOut("fast",function(){$(this).remove()})}else if("SkillAttribution"==eventType){username=eventMessage.user_name,userroles=eventMessage.user_roles.toString().replace(/,/g," "),messageID=eventMessage.id;var eventSource=eventMessage.skill.icon_url,eventName=eventMessage.skill.skill_name,eventCost=eventMessage.skill.cost;completeMessage="used skill: <strong>"+eventName+"</strong> ("+("Sparks"==eventMessage.skill.currency?'<img class="currency currency--sparks" src="assets/sparks.png" alt="Sparks">':'<img class="currency currency--embers" src="https://mixer.com/_static/img/design/ui/embers/ember_20.png" alt="Embers">')+" "+eventCost+')<br><img src="'+eventSource+'" alt="'+eventName+'">';"0"===timeToShowChat?$("<div class='chat__message chat__message--mixer chat__message--skill "+eventMessage.user_id+"' id='"+messageID+"'><div class='chat__message__username chat__message__username--"+userroles+"'>"+username+" <div class='badges'><img class='badges__badge--mixer' src="+subIcon+"></div></div> "+completeMessage+"</div>").appendTo(".chat"):$("<div class='chat__message chat__message--mixer chat__message--skill "+eventMessage.user_id+"' id='"+messageID+"'><div class='chat__message__username chat__message__username--"+userroles+"'>"+username+" <div class='badges'><img class='badges__badge--mixer' src="+subIcon+"></div></div> "+completeMessage+"</div>").appendTo(".chat").hide().fadeIn("fast").delay(timeToShowChat).fadeOut("fast",function(){$(this).remove()})}else"ClearMessages"==eventType?$(".chat__message").remove():"DeleteMessage"==eventType?$("#"+eventMessage.id).remove():"PurgeMessage"==eventType&&$("."+eventMessage.user_id).remove()}function errorHandle(ws){var wsState=ws.readyState;1!==wsState?console.log("Ready state is "+wsState):ws.send('{"type": "method", "method": "ping", "arguments": [], "id": 12}')}$.ajax({url:"https://mixer.com/api/v1/ascension/levels",type:"GET",dataType:"json",beforeSend:setHeader,success:function(data){ascensionLevels=data.levels}}),$.ajax({url:"https://Mixer.com/api/v1/channels/"+username,type:"GET",dataType:"json",beforeSend:setHeader,success:function(data){userID=data.id,userPartner=data.partnered,!0===userPartner?subIcon=data.badge.url:subIcon="",$.ajax({url:"https://Mixer.com/api/v1/chats/"+userID,type:"GET",dataType:"json",beforeSend:setHeader,success:function(data){mixerSocketConnect(data.endpoints)}})}});