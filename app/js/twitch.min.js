var username=getUrlParameter("username"),channels=[username],fadeDelay=5e3,showChannel=!1,useColor=!0,showBadges=!0,showEmotes=!0,doTimeouts=!0,doChatClears=!0,showHosting=!1,showConnectionNotices=!1,twitchEmotes={urlTemplate:"https://static-cdn.jtvnw.net/emoticons/v1/{{id}}/{{image}}",scales:{1:"1.0",2:"2.0",3:"3.0"}},bttvEmotes={urlTemplate:"https://cdn.betterttv.net/emote/{{id}}/{{image}}",scales:{1:"1x",2:"2x",3:"3x"},bots:[],emoteCodeList:[],emotes:[],subEmotesCodeList:[],allowEmotesAnyChannel:!1},emoteScale=3,defaultColors=["rgb(255, 0, 0)","rgb(0, 0, 255)","rgb(0, 128, 0)","rgb(178, 34, 34)","rgb(255, 127, 80)","rgb(154, 205, 50)","rgb(255, 69, 0)","rgb(46, 139, 87)","rgb(218, 165, 32)","rgb(210, 105, 30)","rgb(95, 158, 160)","rgb(30, 144, 255)","rgb(255, 105, 180)","rgb(138, 43, 226)","rgb(0, 255, 127)"],randomColorsChosen={},clientOptions={options:{debug:!1},connection:{reconnect:!0,secure:!0},channels:channels},client=new tmi.client(clientOptions);function dehash(channel){return channel.replace(/^#/,"")}function capitalize(n){return n[0].toUpperCase()+n.substr(1)}function htmlEntities(html){var isArray=Array.isArray(html);return isArray||(html=html.split("")),html=html.map(function(n,i,arr){return 1==n.length?n.replace(/[\u00A0-\u9999<>&]/gim,function(i){return"&#"+i.charCodeAt(0)+";"}):n}),isArray||(html=html.join("")),html}function formatEmotes(text,emotes,channel){emotes=_.extend(emotes||{},do_merge(bttvEmotes.emoteCodeList.map(function(n){var indMap=getIndicesOf(n,text,!0).map(function(m){return[m,m+n.length-1].join("-")}),obj={};return 0===(obj[n]=indMap).lenth?null:obj})));var splitText=text.split("");for(var i in emotes){var e=emotes[i];for(var j in e){var mote=e[j];if("string"==typeof mote){mote=mote.split("-");var length=(mote=[parseInt(mote[0]),parseInt(mote[1])])[1]-mote[0],emote=text.substr(mote[0],length+1),empty=Array.apply(null,new Array(length+1)).map(function(){return""}),permToReplace=!0,options={template:twitchEmotes.urlTemplate,id:i,image:twitchEmotes.scales[emoteScale]};if(-1<bttvEmotes.emoteCodeList.indexOf(emote)){var bttvEmote=_.findWhere(bttvEmotes.emotes,{code:emote});0<bttvEmote.restrictions.channels.length&&-1==bttvEmote.restrictions.channels.indexOf(channel.replace(/^#/,""))&&(permToReplace=!1),options.template=bttvEmotes.urlTemplate,options.id=bttvEmote.id,options.image=bttvEmotes.scales[emoteScale]}if(permToReplace||bttvEmotes.allowEmotesAnyChannel){var html="<img class='emoticon' emote='"+emote+"' src='"+options.template.replace("{{id}}",options.id).replace("{{image}}",options.image)+"'>";(splitText=splitText.slice(0,mote[0]).concat(empty).concat(splitText.slice(mote[1]+1,splitText.length))).splice(mote[0],1,html)}}}}return htmlEntities(splitText).join("")}function mergeBTTVEmotes(data,channel){bttvEmotes.emotes=bttvEmotes.emotes.concat(data.emotes.map(function(n){return _.has(n,"restrictions")||(n.restrictions={channels:[],games:[]}),-1==n.restrictions.channels.indexOf(channel)&&n.restrictions.channels.push(channel),n})),bttvEmotes.bots=bttvEmotes.bots.concat(data.bots.map(function(n){return{name:n,channel:channel}}))}var asyncCalls=[get("https://api.betterttv.net/2/emotes",{},{Accept:"application/json"},"GET",function(data){bttvEmotes.emotes=bttvEmotes.emotes.concat(data.emotes.map(function(n){return n.global=!0,n})),bttvEmotes.subEmotesCodeList=_.chain(bttvEmotes.emotes).where({global:!0}).reject(function(n){return _.isNull(n.channel)}).pluck("code").value()},!1)];function addAsyncCall(channel){asyncCalls.push(get("https://api.betterttv.net/2/channels/"+dehash(channel),{},{Accept:"application/json"},"GET",function(data){mergeBTTVEmotes(data,channel)}),!1)}function badges(chan,user,isBot){function createBadge(name){var badge=document.createElement("div");return badge.className="chat-badge-"+name,badge}var chatBadges=document.createElement("span");return chatBadges.className="chat-badges",isBot?chatBadges.appendChild(createBadge("bot")):(user.username==chan&&chatBadges.appendChild(createBadge("broadcaster")),user["user-type"]&&chatBadges.appendChild(createBadge(user["user-type"])),user.turbo&&chatBadges.appendChild(createBadge("turbo"))),chatBadges}function handleChat(channel,user,message,self){var chan=dehash(channel),name=user.username,chatLine=document.createElement("div"),chatChannel=document.createElement("span"),chatName=document.createElement("span"),chatColon=document.createElement("span"),chatMessage=document.createElement("span"),color=useColor?user.color:"inherit";null===color&&(randomColorsChosen.hasOwnProperty(chan)||(randomColorsChosen[chan]={}),randomColorsChosen[chan].hasOwnProperty(name)?color=randomColorsChosen[chan][name]:(color=defaultColors[Math.floor(Math.random()*defaultColors.length)],randomColorsChosen[chan][name]=color)),chatLine.className="chat-line",chatLine.dataset.username=name,chatLine.dataset.channel=channel,"action"==user["message-type"]&&(chatLine.className+=" chat-action"),chatChannel.className="chat-channel",chatChannel.innerHTML=chan,chatName.className="chat-name",chatName.style.color=color,chatName.innerHTML=user["display-name"]||name,chatColon.className="chat-colon",chatMessage.className="chat-message",chatMessage.style.color=color,chatMessage.innerHTML=linkify(showEmotes?formatEmotes(message,user.emotes,channel):htmlEntities(message)),1<client.opts.channels.length&&showChannel&&chatLine.appendChild(chatChannel),showBadges&&chatLine.appendChild(badges(chan,user,self)),chatLine.appendChild(chatName),chatLine.appendChild(chatColon),chatLine.appendChild(chatMessage),"lutrabot"!=user.username&&("0"===timeToShowChat?$("<div class='chatmessage twitch "+user.username+"'>"+chatLine.outerHTML+"</div>").appendTo(".chat"):$("<div class='chatmessage twitch "+user.username+"'>"+chatLine.outerHTML+"</div>").appendTo(".chat").hide().fadeIn("fast").delay(timeToShowChat).fadeOut("fast",function(){$(this).remove()}),"number"==typeof fadeDelay&&setTimeout(function(){chatLine.dataset.faded=""},fadeDelay))}function chatNotice(information,noticeFadeDelay,level,additionalClasses){var ele=document.createElement("div");return ele.className="chat-line chat-notice",ele.innerHTML=information,void 0!==additionalClasses&&(Array.isArray(additionalClasses)&&(additionalClasses=additionalClasses.join(" ")),ele.className+=" "+additionalClasses),"number"==typeof level&&0!=level&&(ele.dataset.level=level),$("<div class='chatmessage'>"+ele.outerHTML+"</div>").appendTo(".chat").hide().fadeIn("fast").delay(5e3).fadeOut("fast",function(){$(this).remove()}),"number"==typeof noticeFadeDelay&&setTimeout(function(){ele.dataset.faded=""},noticeFadeDelay||500),ele}var recentTimeouts={};function timeout(channel,username){if(!doTimeouts)return!1;recentTimeouts.hasOwnProperty(channel)||(recentTimeouts[channel]={}),(!recentTimeouts[channel].hasOwnProperty(username)||recentTimeouts[channel][username]+1e4<+new Date)&&(recentTimeouts[channel][username]=+new Date,chatNotice(capitalize(username)+" was timed-out in "+capitalize(dehash(channel)),1e3,1,"chat-delete-timeout")),$("."+username).remove()}function clearChat(channel,username){if(!doChatClears)return!1;$(".chatmessage").remove(),chatNotice("Chat was cleared in "+capitalize(dehash(channel)),1e3,1,"chat-delete-clear")}function hosting(channel,target,viewers,unhost){if(!showHosting)return!1;"-"==viewers&&(viewers=0);var chan=dehash(channel);(chan=capitalize(chan),unhost)?chatNotice(chan+" is no longer hosting.",null,null,"chat-hosting-no"):chatNotice(chan+" is now hosting "+capitalize(target)+" for "+viewers+" viewer"+(1!==viewers?"s":"")+".",null,null,"chat-hosting-yes")}client.addListener("message",handleChat),client.addListener("timeout",timeout),client.addListener("clearchat",clearChat),client.addListener("hosting",hosting),client.addListener("unhost",function(channel,viewers){hosting(channel,null,viewers,!0)}),client.addListener("connecting",function(address,port){showConnectionNotices&&chatNotice("Connecting",1e3,-4,"chat-connection-good-connecting")}),client.addListener("logon",function(){showConnectionNotices&&chatNotice("Authenticating",1e3,-3,"chat-connection-good-logon")}),client.addListener("connectfail",function(){showConnectionNotices&&chatNotice("Connection failed",1e3,3,"chat-connection-bad-fail")}),client.addListener("connected",function(address,port){showConnectionNotices&&chatNotice("Connected",1e3,-2,"chat-connection-good-connected"),joinAccounced=[]}),client.addListener("disconnected",function(reason){showConnectionNotices&&chatNotice("Disconnected: "+(reason||""),3e3,2,"chat-connection-bad-disconnected")}),client.addListener("reconnect",function(){showConnectionNotices&&chatNotice("Reconnected",1e3,"chat-connection-good-reconnect")}),client.addListener("join",function(channel,username){username==client.getUsername()&&(showConnectionNotices&&chatNotice("Joined "+capitalize(dehash(channel)),1e3,-1,"chat-room-join"),joinAccounced.push(channel))}),client.addListener("part",function(channel,username){-1<joinAccounced.indexOf(channel)&&(showConnectionNotices&&chatNotice("Parted "+capitalize(dehash(channel)),1e3,-1,"chat-room-part"),joinAccounced.splice(joinAccounced.indexOf(channel),1))}),client.addListener("crash",function(){chatNotice("Crashed",1e4,4,"chat-crash")}),$(document).ready(function(e){for(var i in channels)addAsyncCall(channels[i]);$.when.apply({},asyncCalls).always(function(){bttvEmotes.emoteCodeList=_.pluck(bttvEmotes.emotes,"code"),client.connect()})});